"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TalkAvocadoLambdaStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const sqs = require("aws-cdk-lib/aws-sqs");
const iam = require("aws-cdk-lib/aws-iam");
const logs = require("aws-cdk-lib/aws-logs");
const ecr = require("aws-cdk-lib/aws-ecr");
const yaml = require("js-yaml");
const fs = require("fs");
const path = require("path");
class TalkAvocadoLambdaStack extends cdk.Stack {
  constructor(scope, id, props) {
    super(scope, id, props);
    this.functions = {};
    this.deadLetterQueues = {};
    // Load configuration
    const configPath = path.join(__dirname, "config", "lambda-config.yaml");
    const config = yaml.load(fs.readFileSync(configPath, "utf8"));
    // Create ECR repository reference
    const ecrRepository = ecr.Repository.fromRepositoryName(
      this,
      "FFmpegRuntimeRepository",
      "talk-avocado/ffmpeg-runtime"
    );
    // Create dead letter queues for each service
    Object.keys(config.services).forEach(serviceName => {
      const dlq = new sqs.Queue(this, `${serviceName}-DLQ`, {
        queueName: `talk-avocado-${serviceName}-dlq-${props.environment}`,
        retentionPeriod: cdk.Duration.days(14),
        visibilityTimeout: cdk.Duration.minutes(15),
      });
      this.deadLetterQueues[serviceName] = dlq;
    });
    // Create Lambda functions
    Object.entries(config.services).forEach(([serviceName, serviceConfig]) => {
      const functionName = `talk-avocado-${serviceName}-${props.environment}`;
      // Create IAM role for the function
      const role = new iam.Role(this, `${serviceName}-Role`, {
        assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
        managedPolicies: [
          iam.ManagedPolicy.fromAwsManagedPolicyName(
            "service-role/AWSLambdaBasicExecutionRole"
          ),
        ],
        inlinePolicies: {
          MediaProcessingPolicy: new iam.PolicyDocument({
            statements: [
              new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"],
                resources: [
                  `arn:aws:s3:::talk-avocado-*-${props.environment}/*`,
                ],
              }),
              new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: [
                  "dynamodb:GetItem",
                  "dynamodb:PutItem",
                  "dynamodb:UpdateItem",
                  "dynamodb:Query",
                ],
                resources: [
                  `arn:aws:dynamodb:${this.region}:${this.account}:table/talk-avocado-jobs-${props.environment}`,
                ],
              }),
              new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["xray:PutTraceSegments", "xray:PutTelemetryRecords"],
                resources: ["*"],
              }),
            ],
          }),
        },
      });
      // Create the Lambda function
      const lambdaFunction = new lambda.Function(
        this,
        `${serviceName}-Function`,
        {
          functionName,
          runtime: lambda.Runtime.FROM_IMAGE,
          architecture: lambda.Architecture.X86_64,
          code: lambda.Code.fromEcrImage(ecrRepository, {
            tagOrDigest: "latest", // In production, use specific digest
          }),
          handler: lambda.Handler.FROM_IMAGE,
          memorySize: serviceConfig.memory,
          timeout: cdk.Duration.seconds(serviceConfig.timeout),
          role,
          environment: {
            ...serviceConfig.environment,
            ENVIRONMENT: props.environment,
            TENANT_ID: props.tenantId,
            LOG_LEVEL: "INFO",
            POWERTOOLS_SERVICE_NAME: serviceName,
            POWERTOOLS_METRICS_NAMESPACE: "TalkAvocado",
            POWERTOOLS_LOGGER_LOG_EVENT: "true",
          },
          ephemeralStorageSize: cdk.Size.gibibytes(
            serviceConfig.ephemeral_storage.size
          ),
          deadLetterQueue: this.deadLetterQueues[serviceName],
          reservedConcurrentExecutions: config.common.reserved_concurrency,
          logRetention: logs.RetentionDays.ONE_MONTH,
          tracing: lambda.Tracing.ACTIVE,
          description: serviceConfig.description,
        }
      );
      // Add X-Ray permissions
      lambdaFunction.addToRolePolicy(
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: ["xray:PutTraceSegments", "xray:PutTelemetryRecords"],
          resources: ["*"],
        })
      );
      this.functions[serviceName] = lambdaFunction;
    });
    // Create CloudWatch Alarms
    this.createCloudWatchAlarms(config);
    // Output important values
    new cdk.CfnOutput(this, "FFmpegRuntimeRepositoryURI", {
      value: ecrRepository.repositoryUri,
      description: "ECR Repository URI for FFmpeg runtime image",
    });
    Object.entries(this.functions).forEach(([serviceName, func]) => {
      new cdk.CfnOutput(this, `${serviceName}FunctionArn`, {
        value: func.functionArn,
        description: `${serviceName} Lambda Function ARN`,
      });
    });
  }
  createCloudWatchAlarms(config) {
    // Error rate alarm
    Object.entries(this.functions).forEach(([serviceName, func]) => {
      new cdk.aws_cloudwatch.Alarm(this, `${serviceName}-ErrorRate-Alarm`, {
        alarmName: `TalkAvocado-${serviceName}-ErrorRate`,
        metric: func.metricErrors({
          period: cdk.Duration.minutes(5),
          statistic: "Average",
        }),
        threshold: 0.05, // 5% error rate
        evaluationPeriods: 2,
        treatMissingData: cdk.aws_cloudwatch.TreatMissingData.NOT_BREACHING,
        alarmDescription: `Error rate alarm for ${serviceName}`,
      });
      // Duration alarm
      new cdk.aws_cloudwatch.Alarm(this, `${serviceName}-Duration-Alarm`, {
        alarmName: `TalkAvocado-${serviceName}-Duration`,
        metric: func.metricDuration({
          period: cdk.Duration.minutes(5),
          statistic: "Average",
        }),
        threshold: config.services[serviceName].timeout * 0.9 * 1000, // 90% of timeout
        evaluationPeriods: 2,
        treatMissingData: cdk.aws_cloudwatch.TreatMissingData.NOT_BREACHING,
        alarmDescription: `Duration alarm for ${serviceName}`,
      });
      // DLQ alarm - using CloudWatch metric directly
      new cdk.aws_cloudwatch.Alarm(this, `${serviceName}-DLQ-Alarm`, {
        alarmName: `TalkAvocado-${serviceName}-DLQ`,
        metric: new cdk.aws_cloudwatch.Metric({
          namespace: "AWS/SQS",
          metricName: "ApproximateNumberOfVisibleMessages",
          dimensionsMap: {
            QueueName: this.deadLetterQueues[serviceName].queueName,
          },
        }),
        threshold: 0,
        comparisonOperator:
          cdk.aws_cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
        evaluationPeriods: 1,
        treatMissingData: cdk.aws_cloudwatch.TreatMissingData.NOT_BREACHING,
        alarmDescription: `DLQ alarm for ${serviceName}`,
      });
    });
  }
}
exports.TalkAvocadoLambdaStack = TalkAvocadoLambdaStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGFtYmRhLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFtQztBQUNuQyxpREFBaUQ7QUFDakQsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyw2Q0FBNkM7QUFDN0MsMkNBQTJDO0FBRTNDLGdDQUFnQztBQUNoQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBTzdCLE1BQWEsc0JBQXVCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFJbkQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF1QjtRQUMvRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUpWLGNBQVMsR0FBdUMsRUFBRSxDQUFDO1FBQ25ELHFCQUFnQixHQUFpQyxFQUFFLENBQUM7UUFLbEUscUJBQXFCO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQVEsQ0FBQztRQUVyRSxrQ0FBa0M7UUFDbEMsTUFBTSxhQUFhLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FDckQsSUFBSSxFQUNKLHlCQUF5QixFQUN6Qiw2QkFBNkIsQ0FDOUIsQ0FBQztRQUVGLDZDQUE2QztRQUM3QyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDakQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLFdBQVcsTUFBTSxFQUFFO2dCQUNwRCxTQUFTLEVBQUUsZ0JBQWdCLFdBQVcsUUFBUSxLQUFL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LENBQUM7Z0JBQ3BCLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsYUFBYTtnQkFDbkUsZ0JBQWdCLEVBQUUsaUJBQWlCLFdBQVcsRUFBRTthQUNqRCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQXhMRCx3REF3TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xyXG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XHJcbmltcG9ydCAqIGFzIHNxcyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3FzJztcclxuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xyXG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sb2dzJztcclxuaW1wb3J0ICogYXMgZWNyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lY3InO1xyXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcclxuaW1wb3J0ICogYXMgeWFtbCBmcm9tICdqcy15YW1sJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBMYW1iZGFTdGFja1Byb3BzIGV4dGVuZHMgY2RrLlN0YWNrUHJvcHMge1xyXG4gIGVudmlyb25tZW50OiBzdHJpbmc7XHJcbiAgdGVuYW50SWQ6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFRhbGtBdm9jYWRvTGFtYmRhU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xyXG4gIHB1YmxpYyByZWFkb25seSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogbGFtYmRhLkZ1bmN0aW9uIH0gPSB7fTtcclxuICBwdWJsaWMgcmVhZG9ubHkgZGVhZExldHRlclF1ZXVlczogeyBba2V5OiBzdHJpbmddOiBzcXMuUXVldWUgfSA9IHt9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTGFtYmRhU3RhY2tQcm9wcykge1xyXG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XHJcblxyXG4gICAgLy8gTG9hZCBjb25maWd1cmF0aW9uXHJcbiAgICBjb25zdCBjb25maWdQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbmZpZycsICdsYW1iZGEtY29uZmlnLnlhbWwnKTtcclxuICAgIGNvbnN0IGNvbmZpZyA9IHlhbWwubG9hZChmcy5yZWFkRmlsZVN5bmMoY29uZmlnUGF0aCwgJ3V0ZjgnKSkgYXMgYW55O1xyXG5cclxuICAgIC8vIENyZWF0ZSBFQ1IgcmVwb3NpdG9yeSByZWZlcmVuY2VcclxuICAgIGNvbnN0IGVjclJlcG9zaXRvcnkgPSBlY3IuUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeU5hbWUoXHJcbiAgICAgIHRoaXMsXHJcbiAgICAgICdGRm1wZWdSdW50aW1lUmVwb3NpdG9yeScsXHJcbiAgICAgICd0YWxrLWF2b2NhZG8vZmZtcGVnLXJ1bnRpbWUnXHJcbiAgICApO1xyXG5cclxuICAgIC8vIENyZWF0ZSBkZWFkIGxldHRlciBxdWV1ZXMgZm9yIGVhY2ggc2VydmljZVxyXG4gICAgT2JqZWN0LmtleXMoY29uZmlnLnNlcnZpY2VzKS5mb3JFYWNoKHNlcnZpY2VOYW1lID0+IHtcclxuICAgICAgY29uc3QgZGxxID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCBgJHtzZXJ2aWNlTmFtZX0tRExRYCwge1xyXG4gICAgICAgIHF1ZXVlTmFtZTogYHRhbGstYXZvY2Fkby0ke3NlcnZpY2VOYW1lfS1kbHEtJHtwcm9wcy5lbnZpcm9ubWVudH1gLFxyXG4gICAgICAgIHJldGVudGlvblBlcmlvZDogY2RrLkR1cmF0aW9uLmRheXMoMTQpLFxyXG4gICAgICAgIHZpc2liaWxpdHlUaW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmRlYWRMZXR0ZXJRdWV1ZXNbc2VydmljZU5hbWVdID0gZGxxO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIExhbWJkYSBmdW5jdGlvbnNcclxuICAgIE9iamVjdC5lbnRyaWVzKGNvbmZpZy5zZXJ2aWNlcykuZm9yRWFjaCgoW3NlcnZpY2VOYW1lLCBzZXJ2aWNlQ29uZmlnXTogW3N0cmluZywgYW55XSkgPT4ge1xyXG4gICAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSBgdGFsay1hdm9jYWRvLSR7c2VydmljZU5hbWV9LSR7cHJvcHMuZW52aXJvbm1lbnR9YDtcclxuICAgICAgXHJcbiAgICAgIC8vIENyZWF0ZSBJQU0gcm9sZSBmb3IgdGhlIGZ1bmN0aW9uXHJcbiAgICAgIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgYCR7c2VydmljZU5hbWV9LVJvbGVgLCB7XHJcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2xhbWJkYS5hbWF6b25hd3MuY29tJyksXHJcbiAgICAgICAgbWFuYWdlZFBvbGljaWVzOiBbXHJcbiAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGUnKSxcclxuICAgICAgICBdLFxyXG4gICAgICAgIGlubGluZVBvbGljaWVzOiB7XHJcbiAgICAgICAgICBNZWRpYVByb2Nlc3NpbmdQb2xpY3k6IG5ldyBpYW0uUG9saWN5RG9jdW1lbnQoe1xyXG4gICAgICAgICAgICBzdGF0ZW1lbnRzOiBbXHJcbiAgICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xyXG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxyXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xyXG4gICAgICAgICAgICAgICAgICAnczM6R2V0T2JqZWN0JyxcclxuICAgICAgICAgICAgICAgICAgJ3MzOlB1dE9iamVjdCcsXHJcbiAgICAgICAgICAgICAgICAgICdzMzpEZWxldGVPYmplY3QnLFxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW1xyXG4gICAgICAgICAgICAgICAgICBgYXJuOmF3czpzMzo6OnRhbGstYXZvY2Fkby0qLSR7cHJvcHMuZW52aXJvbm1lbnR9LypgLFxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XHJcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXHJcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXHJcbiAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpHZXRJdGVtJyxcclxuICAgICAgICAgICAgICAgICAgJ2R5bmFtb2RiOlB1dEl0ZW0nLFxyXG4gICAgICAgICAgICAgICAgICAnZHluYW1vZGI6VXBkYXRlSXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICdkeW5hbW9kYjpRdWVyeScsXHJcbiAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbXHJcbiAgICAgICAgICAgICAgICAgIGBhcm46YXdzOmR5bmFtb2RiOiR7dGhpcy5yZWdpb259OiR7dGhpcy5hY2NvdW50fTp0YWJsZS90YWxrLWF2b2NhZG8tam9icy0ke3Byb3BzLmVudmlyb25tZW50fWAsXHJcbiAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcclxuICAgICAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcclxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcclxuICAgICAgICAgICAgICAgICAgJ3hyYXk6UHV0VHJhY2VTZWdtZW50cycsXHJcbiAgICAgICAgICAgICAgICAgICd4cmF5OlB1dFRlbGVtZXRyeVJlY29yZHMnLFxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIHJlc291cmNlczogWycqJ10sXHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIENyZWF0ZSB0aGUgTGFtYmRhIGZ1bmN0aW9uXHJcbiAgICAgIGNvbnN0IGxhbWJkYUZ1bmN0aW9uID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBgJHtzZXJ2aWNlTmFtZX0tRnVuY3Rpb25gLCB7XHJcbiAgICAgICAgZnVuY3Rpb25OYW1lLFxyXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLkZST01fSU1BR0UsXHJcbiAgICAgICAgYXJjaGl0ZWN0dXJlOiBsYW1iZGEuQXJjaGl0ZWN0dXJlLlg4Nl82NCxcclxuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tRWNySW1hZ2UoZWNyUmVwb3NpdG9yeSwge1xyXG4gICAgICAgICAgdGFnT3JEaWdlc3Q6ICdsYXRlc3QnLCAvLyBJbiBwcm9kdWN0aW9uLCB1c2Ugc3BlY2lmaWMgZGlnZXN0XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgaGFuZGxlcjogbGFtYmRhLkhhbmRsZXIuRlJPTV9JTUFHRSxcclxuICAgICAgICBtZW1vcnlTaXplOiBzZXJ2aWNlQ29uZmlnLm1lbW9yeSxcclxuICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyhzZXJ2aWNlQ29uZmlnLnRpbWVvdXQpLFxyXG4gICAgICAgIHJvbGUsXHJcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcclxuICAgICAgICAgIC4uLnNlcnZpY2VDb25maWcuZW52aXJvbm1lbnQsXHJcbiAgICAgICAgICBFTlZJUk9OTUVOVDogcHJvcHMuZW52aXJvbm1lbnQsXHJcbiAgICAgICAgICBURU5BTlRfSUQ6IHByb3BzLnRlbmFudElkLFxyXG4gICAgICAgICAgTE9HX0xFVkVMOiAnSU5GTycsXHJcbiAgICAgICAgICBQT1dFUlRPT0xTX1NFUlZJQ0VfTkFNRTogc2VydmljZU5hbWUsXHJcbiAgICAgICAgICBQT1dFUlRPT0xTX01FVFJJQ1NfTkFNRVNQQUNFOiAnVGFsa0F2b2NhZG8nLFxyXG4gICAgICAgICAgUE9XRVJUT09MU19MT0dHRVJfTE9HX0VWRU5UOiAndHJ1ZScsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZTogY2RrLlNpemUuZ2liaWJ5dGVzKHNlcnZpY2VDb25maWcuZXBoZW1lcmFsX3N0b3JhZ2Uuc2l6ZSksXHJcbiAgICAgICAgZGVhZExldHRlclF1ZXVlOiB0aGlzLmRlYWRMZXR0ZXJRdWV1ZXNbc2VydmljZU5hbWVdLFxyXG4gICAgICAgIHJlc2VydmVkQ29uY3VycmVudEV4ZWN1dGlvbnM6IGNvbmZpZy5jb21tb24ucmVzZXJ2ZWRfY29uY3VycmVuY3ksXHJcbiAgICAgICAgbG9nUmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXMuT05FX01PTlRILFxyXG4gICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcclxuICAgICAgICBkZXNjcmlwdGlvbjogc2VydmljZUNvbmZpZy5kZXNjcmlwdGlvbixcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBBZGQgWC1SYXkgcGVybWlzc2lvbnNcclxuICAgICAgbGFtYmRhRnVuY3Rpb24uYWRkVG9Sb2xlUG9saWN5KFxyXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcclxuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcclxuICAgICAgICAgIGFjdGlvbnM6IFtcclxuICAgICAgICAgICAgJ3hyYXk6UHV0VHJhY2VTZWdtZW50cycsXHJcbiAgICAgICAgICAgICd4cmF5OlB1dFRlbGVtZXRyeVJlY29yZHMnLFxyXG4gICAgICAgICAgXSxcclxuICAgICAgICAgIHJlc291cmNlczogWycqJ10sXHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRoaXMuZnVuY3Rpb25zW3NlcnZpY2VOYW1lXSA9IGxhbWJkYUZ1bmN0aW9uO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIENsb3VkV2F0Y2ggQWxhcm1zXHJcbiAgICB0aGlzLmNyZWF0ZUNsb3VkV2F0Y2hBbGFybXMoY29uZmlnKTtcclxuXHJcbiAgICAvLyBPdXRwdXQgaW1wb3J0YW50IHZhbHVlc1xyXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0ZGbXBlZ1J1bnRpbWVSZXBvc2l0b3J5VVJJJywge1xyXG4gICAgICB2YWx1ZTogZWNyUmVwb3NpdG9yeS5yZXBvc2l0b3J5VXJpLFxyXG4gICAgICBkZXNjcmlwdGlvbjogJ0VDUiBSZXBvc2l0b3J5IFVSSSBmb3IgRkZtcGVnIHJ1bnRpbWUgaW1hZ2UnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKFtzZXJ2aWNlTmFtZSwgZnVuY10pID0+IHtcclxuICAgICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgYCR7c2VydmljZU5hbWV9RnVuY3Rpb25Bcm5gLCB7XHJcbiAgICAgICAgdmFsdWU6IGZ1bmMuZnVuY3Rpb25Bcm4sXHJcbiAgICAgICAgZGVzY3JpcHRpb246IGAke3NlcnZpY2VOYW1lfSBMYW1iZGEgRnVuY3Rpb24gQVJOYCxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRXYXRjaEFsYXJtcyhjb25maWc6IGFueSkge1xyXG4gICAgLy8gRXJyb3IgcmF0ZSBhbGFybVxyXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKFtzZXJ2aWNlTmFtZSwgZnVuY10pID0+IHtcclxuICAgICAgY29uc3QgZXJyb3JSYXRlQWxhcm0gPSBuZXcgY2RrLmF3c19jbG91ZHdhdGNoLkFsYXJtKHRoaXMsIGAke3NlcnZpY2VOYW1lfS1FcnJvclJhdGUtQWxhcm1gLCB7XHJcbiAgICAgICAgYWxhcm1OYW1lOiBgVGFsa0F2b2NhZG8tJHtzZXJ2aWNlTmFtZX0tRXJyb3JSYXRlYCxcclxuICAgICAgICBtZXRyaWM6IGZ1bmMubWV0cmljRXJyb3JzKHtcclxuICAgICAgICAgIHBlcmlvZDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXHJcbiAgICAgICAgICBzdGF0aXN0aWM6ICdBdmVyYWdlJyxcclxuICAgICAgICB9KSxcclxuICAgICAgICB0aHJlc2hvbGQ6IDAuMDUsIC8vIDUlIGVycm9yIHJhdGVcclxuICAgICAgICBldmFsdWF0aW9uUGVyaW9kczogMixcclxuICAgICAgICB0cmVhdE1pc3NpbmdEYXRhOiBjZGsuYXdzX2Nsb3Vkd2F0Y2guVHJlYXRNaXNzaW5nRGF0YS5OT1RfQlJFQUNISU5HLFxyXG4gICAgICAgIGFsYXJtRGVzY3JpcHRpb246IGBFcnJvciByYXRlIGFsYXJtIGZvciAke3NlcnZpY2VOYW1lfWAsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gRHVyYXRpb24gYWxhcm1cclxuICAgICAgY29uc3QgZHVyYXRpb25BbGFybSA9IG5ldyBjZGsuYXdzX2Nsb3Vkd2F0Y2guQWxhcm0odGhpcywgYCR7c2VydmljZU5hbWV9LUR1cmF0aW9uLUFsYXJtYCwge1xyXG4gICAgICAgIGFsYXJtTmFtZTogYFRhbGtBdm9jYWRvLSR7c2VydmljZU5hbWV9LUR1cmF0aW9uYCxcclxuICAgICAgICBtZXRyaWM6IGZ1bmMubWV0cmljRHVyYXRpb24oe1xyXG4gICAgICAgICAgcGVyaW9kOiBjZGsuRHVyYXRpb24ubWludXRlcyg1KSxcclxuICAgICAgICAgIHN0YXRpc3RpYzogJ0F2ZXJhZ2UnLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRocmVzaG9sZDogY29uZmlnLnNlcnZpY2VzW3NlcnZpY2VOYW1lXS50aW1lb3V0ICogMC45ICogMTAwMCwgLy8gOTAlIG9mIHRpbWVvdXRcclxuICAgICAgICBldmFsdWF0aW9uUGVyaW9kczogMixcclxuICAgICAgICB0cmVhdE1pc3NpbmdEYXRhOiBjZGsuYXdzX2Nsb3Vkd2F0Y2guVHJlYXRNaXNzaW5nRGF0YS5OT1RfQlJFQUNISU5HLFxyXG4gICAgICAgIGFsYXJtRGVzY3JpcHRpb246IGBEdXJhdGlvbiBhbGFybSBmb3IgJHtzZXJ2aWNlTmFtZX1gLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIERMUSBhbGFybSAtIHVzaW5nIENsb3VkV2F0Y2ggbWV0cmljIGRpcmVjdGx5XHJcbiAgICAgIGNvbnN0IGRscUFsYXJtID0gbmV3IGNkay5hd3NfY2xvdWR3YXRjaC5BbGFybSh0aGlzLCBgJHtzZXJ2aWNlTmFtZX0tRExRLUFsYXJtYCwge1xyXG4gICAgICAgIGFsYXJtTmFtZTogYFRhbGtBdm9jYWRvLSR7c2VydmljZU5hbWV9LURMUWAsXHJcbiAgICAgICAgbWV0cmljOiBuZXcgY2RrLmF3c19jbG91ZHdhdGNoLk1ldHJpYyh7XHJcbiAgICAgICAgICBuYW1lc3BhY2U6ICdBV1MvU1FTJyxcclxuICAgICAgICAgIG1ldHJpY05hbWU6ICdBcHByb3hpbWF0ZU51bWJlck9mVmlzaWJsZU1lc3NhZ2VzJyxcclxuICAgICAgICAgIGRpbWVuc2lvbnNNYXA6IHtcclxuICAgICAgICAgICAgUXVldWVOYW1lOiB0aGlzLmRlYWRMZXR0ZXJRdWV1ZXNbc2VydmljZU5hbWVdLnF1ZXVlTmFtZSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgdGhyZXNob2xkOiAwLFxyXG4gICAgICAgIGNvbXBhcmlzb25PcGVyYXRvcjogY2RrLmF3c19jbG91ZHdhdGNoLkNvbXBhcmlzb25PcGVyYXRvci5HUkVBVEVSX1RIQU5fVEhSRVNIT0xELFxyXG4gICAgICAgIGV2YWx1YXRpb25QZXJpb2RzOiAxLFxyXG4gICAgICAgIHRyZWF0TWlzc2luZ0RhdGE6IGNkay5hd3NfY2xvdWR3YXRjaC5UcmVhdE1pc3NpbmdEYXRhLk5PVF9CUkVBQ0hJTkcsXHJcbiAgICAgICAgYWxhcm1EZXNjcmlwdGlvbjogYERMUSBhbGFybSBmb3IgJHtzZXJ2aWNlTmFtZX1gLFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=
